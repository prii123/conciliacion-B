{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Detalle Conciliación #{{ conciliacion.id }}{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/lista_conciliaciones" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Volver a Lista
    </a>
</div>

{{ macros.stats_card(stats) }}

{{ macros.progress_bar(stats.porcentaje_conciliacion, stats.conciliados, stats.total_movimientos) }}

<div class="card mb-3">
    <div class="card-body">
        <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Información de la Conciliación</h5>
        <div class="row">
            <div class="col-md-6">
                {{ macros.info_row('hash', 'ID', '#' ~ conciliacion.id) }}
                {{ macros.info_row('calendar-month', 'Periodo', conciliacion.mes_conciliado ~ ' ' ~
                conciliacion.año_conciliado) }}
                {{ macros.info_row('credit-card', 'Cuenta', conciliacion.cuenta_conciliada) }}
            </div>
            <div class="col-md-6">
                {{ macros.info_row('calendar3', 'Fecha Proceso', conciliacion.fecha_proceso) }}
                <div class="info-row">
                    <i class="bi bi-check-circle"></i>
                    <span class="info-label">Estado:</span>
                    {{ macros.badge_estado(conciliacion.estado) }}
                </div>
                <div class="info-row">
                    <form action="{{ url_for('procesar_conciliacion', conciliacion_id=conciliacion.id) }}" 
                        method="post">
                        <button type="submit" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-repeat me-2"></i> Procesar conciliación Automaticamente
                        </button>
                    </form>
                </div>

                <div class="col-md-6">
                    {% if conciliacion.estado != 'finalizada' %}
                    <form action="{{ url_for('terminar_conciliacion', conciliacion_id=conciliacion.id) }}" method="post"
                        onsubmit="return confirm('¿Está seguro de terminar la conciliación? Esta acción marcará la conciliación como finalizada.')">
                        <button type="submit" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-repeat me-2"></i> Terminar conciliación
                        </button>
                    </form>
                    {% else %}
                    <button class="btn btn-success" disabled>
                        <i class="bi bi-check-circle me-2"></i> Finalizada
                    </button>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
</div>

<div class="mb-4">
    <a href="/matches_conciliacion/{{ conciliacion.id }}" class="btn btn-primary">
        <i class="bi bi-link-45deg me-2"></i> Ver Matches de Conciliación
    </a>
</div>

<div class="tabs-container">
    <button id="btnOkBanco" class="btn btn-primary mt-2">Ir a Auxiliar</button>
    <button id="btnConfirmarConciliacion" class="btn btn-success mt-2">Confirmar Conciliación</button>


    <ul class="nav nav-tabs" id="movimientosTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="banco-tab" data-bs-toggle="tab" data-bs-target="#banco" type="button"
                role="tab">
                <i class="bi bi-bank me-2"></i>Banco No Conciliados ({{ movimientos_no_conciliados.banco|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="auxiliar-tab" data-bs-toggle="tab" data-bs-target="#auxiliar" type="button"
                role="tab">
                <i class="bi bi-journal-text me-2"></i>Auxiliar No Conciliados ({{
                movimientos_no_conciliados.auxiliar|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="conciliados-tab" data-bs-toggle="tab" data-bs-target="#conciliados"
                type="button" role="tab">
                <i class="bi bi-check-circle me-2"></i>Conciliados ({{ movimientos_conciliados|length }})
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="banco" role="tabpanel">
            {{ macros.tabla_movimientos(movimientos_no_conciliados.banco, 'banco', true) }}
        </div>

        <div class="tab-pane fade" id="auxiliar" role="tabpanel">
            {{ macros.tabla_movimientos(movimientos_no_conciliados.auxiliar, 'auxiliar', true) }}
        </div>

        <div class="tab-pane fade" id="conciliados" role="tabpanel">
            <div class="table-container">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Descripción</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                            <th>Origen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mov in movimientos_conciliados %}
                        <tr>
                            <td>{{ mov.id }}</td>
                            <td>{{ mov.fecha }}</td>
                            <td>{{ mov.descripcion }}</td>
                            <td>${{ "{:,.2f}".format(mov.valor) }}</td>
                            <td>{{ macros.badge_tipo(mov.es) }}</td>
                            <td>{{ macros.badge_origen(mov.tipo) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}


<script>
    // =============================
    // DATOS DE MOVIMIENTOS (desde Jinja)
    // =============================
    const movimientosBancoData = {};
    {% for mov in movimientos_no_conciliados.banco|default([]) %}
    movimientosBancoData["{{ mov.id|escape }}"] = {
        id: "{{ mov.id|escape }}",
        fecha: "{{ mov.fecha|escape }}",
        descripcion: "{{ mov.descripcion|escape }}",
        valor: "{{ mov.valor|default(0) }}",
        es: "{{ mov.es|escape }}"
    };
    {% endfor %}

    const movimientosAuxiliarData = {};
    {% for mov in movimientos_no_conciliados.auxiliar|default([]) %}
    movimientosAuxiliarData["{{ mov.id|escape }}"] = {
        id: "{{ mov.id|escape }}",
        fecha: "{{ mov.fecha|escape }}",
        descripcion: "{{ mov.descripcion|escape }}",
        valor: "{{ mov.valor|default(0) }}",
        es: "{{ mov.es|escape }}"
    };
    {% endfor %}

    const conciliacionId = "{{ conciliacion.id|escape }}";

    // =============================
    // ESTADO DE SELECCIÓN
    // =============================
    let seleccionBanco = [];
    let tipoBancoSeleccionado = null; // 'E' o 'S'
    let seleccionAuxiliar = [];

    // =============================
    // INICIALIZACIÓN Y EVENTOS
    // =============================
    document.addEventListener('DOMContentLoaded', () => {
        MovimientoSelector.init(movimientosBancoData, movimientosAuxiliarData);
    });

    // =============================
    // BOTÓN: OK → Ir a Auxiliar
    // =============================
    document.getElementById('btnOkBanco').addEventListener('click', () => {
        const selecciones = MovimientoSelector.getSelecciones();
        const seleccionadosBanco = selecciones.banco;
        console.log( 'boton ir a auxiliar');
        console.log(seleccionadosBanco);
        if (!seleccionadosBanco || seleccionadosBanco.length === 0) {
            alert('Seleccione al menos un movimiento de banco.');
            return;
        }

        const tipos = new Set(seleccionadosBanco.map(id => movimientosBancoData[id].es));
        if (tipos.size > 1) {
            alert('Seleccione solo movimientos del mismo tipo (E o S).');
            return;
        }

        tipoBancoSeleccionado = [...tipos][0];
        seleccionBanco = seleccionadosBanco;

        // Cambiar pestaña automáticamente
        const auxTab = new bootstrap.Tab(document.getElementById('auxiliar-tab'));
        auxTab.show();
    });

    // =============================
    // BOTÓN: Confirmar Conciliación
    // =============================
    document.getElementById('btnConfirmarConciliacion').addEventListener('click', () => {
        const selecciones = MovimientoSelector.getSelecciones();
        const seleccionadosAux = selecciones.auxiliar;

        if (!seleccionadosAux || seleccionadosAux.length === 0) {
            alert('Seleccione al menos un movimiento auxiliar.');
            return;
        }

        const tiposAux = new Set(seleccionadosAux.map(id => movimientosAuxiliarData[id].es));
        if (tiposAux.size > 1 || [...tiposAux][0] !== tipoBancoSeleccionado) {
            alert('Los movimientos auxiliares deben ser del mismo tipo (E o S) que los del banco.');
            return;
        }

        seleccionAuxiliar = seleccionadosAux;

        const payload = {
            id_banco: seleccionBanco,
            id_auxiliar: seleccionAuxiliar
        };

        fetch(`{{ url_for('conciliar_manual', conciliacion_id=conciliacion.id) }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(async res => {
                const data = await res.json().catch(() => ({}));
                if (res.ok && data.success) {
                    alert(data.mensaje || 'Conciliación creada correctamente.');
                    window.location.reload();
                } else {
                    alert(data.error || 'Error al crear la conciliación manual.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error de red al intentar crear la conciliación.');
            });
    });



    document.addEventListener('DOMContentLoaded', () => {
        const modalBtn = document.getElementById('modalConfirmarBtn');
        const mainBtn = document.getElementById('btnConfirmarConciliacion');
        if (modalBtn && mainBtn) {
            modalBtn.addEventListener('click', () => {
                // dispara el mismo handler que el botón principal (valida y envía selecciones)
                mainBtn.click();
                // cierra el modal si está abierto
                const modalEl = document.getElementById('conciliarModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            });
        }
    });





</script>



{% endblock %}