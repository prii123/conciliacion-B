{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Matches Conciliaci칩n #{{ conciliacion.id }}{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/conciliacion/{{ conciliacion.id }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Volver al Detalle
    </a>
</div>

{{ macros.page_header('<i class="bi bi-link-45deg me-2"></i>Matches de Conciliaci칩n #' ~ conciliacion.id, conciliacion.mes_conciliado ~ ' ' ~ conciliacion.a침o_conciliado ~ ' - ' ~ conciliacion.cuenta_conciliada, 'green') }}

<div class="row mb-4">
    <div class="col-md-4">
        <div class="match-stats">
            <div class="stat-value-large">{{ matches|length }}</div>
            <div class="text-muted">Total Matches</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="match-stats">
            <div class="stat-value-large">
                {{ matches|selectattr('match.criterio_match', 'contains', 'exacto')|list|length }}
            </div>
            <div class="text-muted">Exactos</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="match-stats">
            <div class="stat-value-large">
                {{ matches|selectattr('match.criterio_match', 'contains', 'manual')|list|length }}
            </div>
            <div class="text-muted">Manuales</div>
        </div>
    </div>
</div>

<div class="filter-section">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h5 class="mb-0"><i class="bi bi-filter me-2"></i>Filtrar Matches</h5>
        </div>
        <div class="col-md-6">
            <select class="form-select" id="filterCriterio" onchange="Filtros.filtrarPorCriterio('matchesContainer', 'filterCriterio', 'criterio')">
                <option value="todos">Todos los tipos</option>
                <option value="exacto">Solo Exactos</option>
                <option value="aproximado">Solo Aproximados</option>
                <option value="manual">Solo Manuales</option>
            </select>
        </div>
    </div>
</div>

{% if matches %}
    <div id="matchesContainer">
        {% for item in matches %}
        <div class="match-card {{ 'exacto' if 'exacto' in item.match.criterio_match else ('manual' if 'manual' in item.match.criterio_match else 'aproximado') }}" 
             data-criterio="{{ item.match.criterio_match }}">
            <div class="match-header">
                <div>
                    <h5 class="mb-2">
                        Match #{{ item.match.id }}
                        <span class="match-badge {{ 'badge-exacto' if 'exacto' in item.match.criterio_match else ('badge-manual' if 'manual' in item.match.criterio_match else 'badge-aproximado') }}">
                            {% if 'exacto' in item.match.criterio_match %}
                                <i class="bi bi-check-circle me-1"></i>Exacto
                            {% elif 'manual' in item.match.criterio_match %}
                                <i class="bi bi-hand-index me-1"></i>Manual
                            {% else %}
                                <i class="bi bi-diagram-3 me-1"></i>Aproximado
                            {% endif %}
                        </span>
                    </h5>
                    <small class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>{{ item.match.fecha_match }}
                    </small>
                </div>
                {% if 'manual' in item.match.criterio_match %}
                <button class="btn btn-danger btn-sm" onclick="Conciliacion.eliminarMatch({{ item.match.id }})">
                    <i class="bi bi-trash me-1"></i>Eliminar
                </button>
                {% endif %}
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    {{ macros.movimiento_detail(item.movimiento_banco, 'banco') }}
                </div>
                <div class="col-md-6">
                    {{ macros.movimiento_detail(item.movimiento_auxiliar, 'auxiliar') }}
                </div>
            </div>
            
            <div class="mt-3 p-3 bg-light rounded">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Criterio:</strong> {{ item.match.criterio_match }}
                    </div>
                    <div class="col-md-6">
                        <strong>Diferencia:</strong> ${{ "{:,.2f}".format(item.match.diferencia_valor) }}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    {{ macros.empty_state('link-45deg', 'No se encontraron matches para esta conciliaci칩n') }}
{% endif %}
{% endblock %}